@page "/"
@using SharedNotes.Interfaces
@using SharedNotes.Model
@attribute [StreamRendering]
@inject INotesRepository Repository
@rendermode InteractiveServer

<PageTitle>Notes</PageTitle>

<div class="header-panel flex-space-between">
	<button class="white-button mr-10" @onclick="() => EditNote(0)">New note</button>
	<div class="header-panel-item bg-col-white width-50">
		Search
	</div>
	<div class="header-panel-item ml-10">
		Total notes:
		@if (Notes != null)
		{
			<span>@Notes.Count</span>
		}
	</div>
</div>

<div class="content">
	@if (EditingNoteId != -1)
	{
		<EditForm Model="EditingNote" OnValidSubmit="SaveNote" FormName="EditNoteForm" class="edit-note-form">
			<DataAnnotationsValidator/>
			<ValidationSummary/>

			<div>
				<InputText @bind-Value="EditingNote.Title" class="input-text mb-10" placeholder="Title"/>
			</div>
			<div>
				<InputTextArea @bind-Value="EditingNote.Body" class="input-text height-200px" placeholder=""/>
			</div>

			<div>
				<button class="white-button" type="submit">Save</button>
			</div>
		</EditForm>
	}

	@if (EditingNoteId == -1)
	{
		@if (Notes == null)
		{
			<p>
				<em>Loading...</em>
			</p>
		}
		else if (!Notes.Any())
		{
			<p>
				<em>No notes</em>
			</p>
		}
		else
		{
			<div class="notes-list">
				@foreach (var item in Notes)
				{
					<div class="note-in-list">
						<div class="flex-space-between">
							<div class="note-in-list-item width-50">@item.Title</div>
							<div class="note-in-list-item">@item.LastEdit</div>
							<div class="note-in-list-item-buttons flex-space-between">
								@if (ViewNote == item.Id)
								{
									<button class="white-button mr-10" @onclick="() => ViewNote = -1">Hide note</button>
								}
								else
								{
									<button class="white-button mr-10" @onclick="() => ViewNote = item.Id">View note</button>
								}
								<button class="white-button" @onclick="() => EditNote(item.Id)">Edit note</button>
							</div>
						</div>
						@if (ViewNote == item.Id)
						{
							<div class="note-in-list-view">
								@item.Body
							</div>
						}
					</div>
				}
			</div>
		}
	}
</div>

@code {
	private int EditingNoteId = -1; // -1 - none; 0 - new note
	private int ViewNote = -1; // -1 - none

	private List<Note> Notes = null!;

	[SupplyParameterFromForm]
	private Note? EditingNote { get; set; }

	protected override async Task OnInitializedAsync()
	{
		Notes = Repository.GetAllNotesOrderByLastEditDesc()
			.ToList();
	}

	private void EditNote(int id)
	{
		if (id == 0) // new note
		{
			EditingNoteId = 0;
			EditingNote = new Note()
			{
				Created = DateTime.UtcNow,
				LastEdit = DateTime.UtcNow,
			};

			return;
		}

		EditingNoteId = id;
		EditingNote = Notes.Find(i => i.Id == id);
	}

	private async Task SaveNote()
	{
		if (EditingNoteId == 0) // new note
		{
			EditingNote.LastEdit = DateTime.UtcNow;
			await Repository.AddNoteAsync(EditingNote);
			await Repository.Commit();

			Notes.Add(EditingNote);
		}
		else
		{
			EditingNote.LastEdit = DateTime.UtcNow;

			await Repository.Commit();
		}

		EditingNoteId = -1;
		EditingNote = null;

		Notes = Notes
			.OrderByDescending(l => l.LastEdit)
			.ToList();
	}

}